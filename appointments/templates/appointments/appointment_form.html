{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2>Créer un rendez-vous</h2>
  <form method="post" novalidate>
    {% csrf_token %}
    <div class="mb-3">
      {{ form.patient.label_tag }}
      {{ form.patient }}
      {{ form.patient.errors }}
    </div>

    <!-- Section auto-remplie après choix du patient -->
    <div id="patient-details" class="alert alert-info d-none">
      <p><strong>Nom :</strong> <span id="patient-name"></span></p>
      <p><strong>Médecin :</strong> <span id="patient-medecin"></span></p>
      <p><strong>Téléphone :</strong> <span id="patient-phone"></span></p>
      <p><strong>Email :</strong> <span id="patient-email"></span></p>
    </div>
    <div class="mb-3 d-none">
      {{ form.medecin }}
      {{ form.medecin.errors }}
      <span id="patient-medecin"></span>
    </div>


    <div class="mb-3">
      {{ form.datetime.label_tag }}
      {{ form.datetime }}
      {{ form.datetime.errors }}
    </div>

    <div class="mb-3">
      {{ form.reason.label_tag }}
      {{ form.reason }}
      {{ form.reason.errors }}
      {{ form.reason.errors }}
    </div>

    <div class="mb-3">
      {{ form.status.label_tag }}
      {{ form.status }}
      {{ form.status.errors }}
    </div>
    <button type="submit" class="btn btn-primary">Enregistrer</button>

  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const patientSelect = document.getElementById("id_patient");
    const patientDetails = document.getElementById("patient-details");
    const nameField = document.getElementById("patient-name");
    const phoneField = document.getElementById("patient-phone");
    const emailField = document.getElementById("patient-email");
    const medecinField = document.getElementById("id_medecin");


    // Prépare une liste JSON envoyée depuis le backend
    const patientsData = {{ patients_json|safe }};

  patientSelect.addEventListener("change", function() {
    const patientId = this.value;
    if (patientsData[patientId]) {
      patientDetails.classList.remove("d-none");
      nameField.textContent = patientsData[patientId].name;
      phoneField.textContent = patientsData[patientId].phone;
      emailField.textContent = patientsData[patientId].email || "N/A";

      // injecter l'ID du médecin dans le champ du formulaire
      if (patientsData[patientId].medecin_id) {
        medecinField.value = patientsData[patientId].medecin_id;
      } else {
        medecinField.value = "";  // si aucun médecin attribué
      }

    } else {
      patientDetails.classList.add("d-none");
    }
  });
});  

document.getElementById("patient-medecin").textContent = patientsData[patientId].medecin || "Non attribué";

</script>
{% endblock %}
