{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Liste des factures</h2>
    <div>
      <a class="btn btn-primary" href="{% url 'billing:invoice_create' %}">➕ Nouvelle facture</a>
    </div>
  </div>

  <!-- Recherche / filtre simple -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <input type="search" name="q" value="{{ request.GET.q|default_if_none:'' }}" class="form-control" placeholder="Rechercher par patient, id...">
    </div>
    <div class="col-auto">
      <select name="status" class="form-select">
        <option value="">Tous statuts</option>
        {% for key, val in invoice.STATUS_CHOICES %}
          <option value="{{ key }}" {% if request.GET.status == key|stringformat:"s" %}selected{% endif %}>{{ val }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-secondary" type="submit">Filtrer</button>
    </div>
  </form>

  {% if invoices %}
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Patient</th>
          <th>Date</th>
          <th class="text-end">Montant</th>
          <th>Statut</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for invoice in invoices %}
        <tr>
          <td>#{{ invoice.id }}</td>
          <td>{{ invoice.patient }}</td>
          <td>{{ invoice.created_at|date:"d/m/Y" }}</td>
          <td class="text-end">{{ invoice.amount }} €</td>
          <td>
            <span class="badge {% if invoice.status == 'paid' %}bg-success{% elif invoice.status == 'pending' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ invoice.get_status_display }}</span>
          </td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-primary" href="{% url 'billing:invoice_detail' invoice.pk %}">Voir</a>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'billing:invoice_update' invoice.pk %}">Modifier</a>

            <!-- Suppression via POST pour sécurité -->
            <form method="post" action="{% url 'billing:invoice_delete' invoice.pk %}" class="d-inline-block" onsubmit="return confirm('Confirmer la suppression de la facture #{{ invoice.id }} ?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination (si la vue fournit 'invoices' paginée) -->
  {% if invoices.has_other_pages %}
  <nav aria-label="Pagination" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if invoices.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ invoices.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Préc</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Préc</span></li>
      {% endif %}

      {% for num in invoices.paginator.page_range %}
        {% if invoices.number == num %}
          <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if invoices.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ invoices.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Suiv</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Suiv</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
    <div class="alert alert-info">Aucune facture enregistrée.</div>
  {% endif %}
</div>

{% endblock %}
